name: Full CI/CD Python Deploy to EC2 server

on:
  push:
    branches:
      - main

jobs:
  # 1ï¸âƒ£ PLAN JOB (auto runs)
  plan:
    name: Plan / Prepare Deployment
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Validate repo & show plan
      run: |
        echo "=== PLAN STAGE ==="
        echo "Code checked out"
        echo "Deployment plan ready"
        ls -la

  # 2ï¸âƒ£ DEPLOY JOB (needs approval)
  deploy:
    name: Deploy to Production EC2
    needs: plan
    runs-on: ubuntu-latest

    # ðŸ” Manual approval happens here
    environment:
      name: production

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh

        printf "%s\n" "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Test SSH connection
      run: |
        ssh -i ~/.ssh/id_rsa \
        ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo SSH OK"

    - name: Copy application code
      run: |
        rsync -avz \
        -e "ssh -i ~/.ssh/id_rsa" \
        . ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ec2-user/app

    - name: Install dependencies & run app
      run: |
        ssh -i ~/.ssh/id_rsa \
        ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e

          APP_DIR=/home/ec2-user/app

          echo "=== Updating system ==="
          sudo yum update -y

          echo "=== Installing Python ==="
          sudo yum install -y python3 python3-pip

          echo "=== App directory ==="
          mkdir -p $APP_DIR
          cd $APP_DIR

          echo "=== Install Python dependencies ==="
          if [ -f requirements.txt ]; then
            pip3 install --user -r requirements.txt
          fi

          echo "=== Restart app ==="
          pkill -f app.py || true
          nohup python3 app.py > app.log 2>&1 &

          echo "=== Deployment complete ==="
        EOF
