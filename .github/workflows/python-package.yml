name: Full CI/CD Python Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2️⃣ Setup SSH
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh

        printf "%s\n" "${{ secrets.EC2_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    # 3️⃣ Test SSH
    - name: Test SSH connection
      run: |
        ssh -i ~/.ssh/id_rsa \
        ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo SSH OK"

    # 4️⃣ Copy code to EC2
    - name: Copy application code
      run: |
        rsync -avz \
        -e "ssh -i ~/.ssh/id_rsa" \
        . ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/ec2-user/app

    # 5️⃣ FULL remote setup + run (ALL AUTOMATED)
    - name: Install dependencies & run app
      run: |
        ssh -i ~/.ssh/id_rsa \
        ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          set -e

          APP_DIR=/home/ec2-user/app

          echo "=== Updating system ==="
          sudo yum update -y

          echo "=== Installing Python ==="
          sudo yum install -y python3 python3-pip

          echo "=== App directory ==="
          mkdir -p $APP_DIR
          cd $APP_DIR

          echo "=== Install Python dependencies ==="
          if [ -f requirements.txt ]; then
            pip3 install --user -r requirements.txt
          fi

          echo "=== Restart app ==="
          pkill -f app.py || true
          nohup python3 app.py > app.log 2>&1 &

          echo "=== Deployment complete ==="
        EOF
